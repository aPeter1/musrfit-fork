#---------------------------------------------------
# Makefile.libTFitPofB
#
# Author: Bastian M. Wojek
# e-mail: bastian.wojek@psi.ch
#
# $Id$
#
#---------------------------------------------------

#---------------------------------------------------
# get compilation and library flags from root-config

ROOTCFLAGS    = $(shell $(ROOTSYS)/bin/root-config --cflags)
ROOTLIBS      = $(shell $(ROOTSYS)/bin/root-config --libs)
ROOTGLIBS     = $(shell $(ROOTSYS)/bin/root-config --glibs)

#---------------------------------------------------
# depending on the architecture, choose the compiler,
# linker, and the flags to use
#

ARCH = $(shell $(ROOTSYS)/bin/root-config --arch)

ifeq ($(ARCH),linux)
OS = LINUX
endif
ifeq ($(ARCH),linuxx8664gcc)
OS = LINUX
endif
ifeq ($(ARCH),win32gcc)
OS = WIN32GCC
endif
ifeq ($(ARCH),macosx)
OS = DARWIN
endif

# -- Linux
ifeq ($(OS),LINUX)
CXX           = g++
CXXFLAGS      = -O3 -Wall -Wno-trigraphs -fPIC
PMUSRPATH     = ../../../include
MNPATH        = $(ROOTSYS)/include
LOCALPATH     = ../include
FFTW3PATH     = /usr/include
INCLUDES      = -I$(LOCALPATH) -I$(PMUSRPATH) -I$(MNPATH) -I$(FFTW3PATH)
LD            = g++
LDFLAGS       = -O
SOFLAGS       = -shared
SHLIB         = libTFitPofB.so
endif

# -- Windows/Cygwin
ifeq ($(OS),WIN32GCC)
CXX           = g++
CXXFLAGS      = -O3 -Wall -Wno-trigraphs -D_DLL
PMUSRPATH     = ../../../include
MNPATH        = $(ROOTSYS)/include
LOCALPATH     = ../include
FFTW3PATH     = /usr/include
INCLUDES      = -I$(LOCALPATH) -I$(PMUSRPATH) -I$(MNPATH) -I$(FFTW3PATH)
LD            = g++
LDFLAGS       = -O -Wl,--enable-auto-import -Wl,--enable-runtime-pseudo-reloc
SOFLAGS       = -shared -Wl,--export-all-symbols
SHLIB         = libTFitPofB.dll
endif

# -- MacOSX/Darwin
ifeq ($(OS),DARWIN)
CXX           = g++
CXXFLAGS      = -O3 -Wall -Wno-trigraphs -fPIC
PMUSRPATH     = ../../../include
MNPATH        = $(ROOTSYS)/include
FINKPATH      = /sw/include
LOCALPATH     = ../include
FFTW3PATH     = /sw/include
INCLUDES      = -I$(LOCALPATH) -I$(PMUSRPATH) -I$(MNPATH) -I$(FINKPATH) -I$(FFTW3PATH)
LD            = g++
LDFLAGS       = -O -Xlinker -bind_at_load
SOFLAGS       = -dynamiclib -flat_namespace -undefined suppress -Wl,-x
SHLIB         = libTFitPofB.dylib
endif

# the output from the root-config script:
CXXFLAGS      += $(ROOTCFLAGS)
LDFLAGS       +=

# the ROOT libraries (G = graphic)
LIBS          = $(ROOTLIBS)
GLIBS         = $(ROOTGLIBS)

# PMusr lib
PMUSRLIB      = -L$(ROOTSYS)/lib -lPMusr
# FFTW lib
FFTW3LIB      = -lfftw3_threads -lfftw3 -lm -lpthread

ifeq ($(OS),WIN32GCC)
# PMusr lib
PMUSRLIB      = -L$(ROOTSYS)/lib -lPMusr -lMathMore
endif

ifeq ($(OS),DARWIN)
# FFTW lib
FFTW3LIB      = -L/sw/lib -lfftw3_threads -lfftw3 -lm -lpthread
# PMusr lib
PMUSRLIB      = -L$(ROOTSYS)/lib -lPMusr -lMathMore
endif

# some definitions: headers (used to generate *Dict* stuff), sources, objects,...
OBJS =
OBJS += TTrimSPDataHandler.o
OBJS += TBulkVortexFieldCalc.o
OBJS += TBofZCalc.o
OBJS += TPofBCalc.o
OBJS += TPofTCalc.o
OBJS += TFitPofBStartupHandler.o TFitPofBStartupHandlerDict.o
OBJS += TVortex.o TVortexDict.o
OBJS += TLondon1D.o TLondon1DDict.o
OBJS += TSkewedGss.o TSkewedGssDict.o

INST_HEADER =
INST_HEADER += ../include/TBofZCalc.h
INST_HEADER += ../include/TBulkVortexFieldCalc.h
INST_HEADER += ../include/TFitPofBStartupHandler.h
INST_HEADER += ../include/TLondon1D.h
INST_HEADER += ../include/TPofBCalc.h
INST_HEADER += ../include/TPofTCalc.h
INST_HEADER += ../include/TSkewedGss.h 
INST_HEADER += ../include/TTrimSPDataHandler.h
INST_HEADER += ../include/TVortex.h

# make the shared libs:

all:  $(SHLIB)

$(SHLIB): $(EXTOBJS) $(OBJS)
	@echo "---> Building shared library $(SHLIB) ..."
	/bin/rm -f $(SHLIB)
	$(LD) $(SOFLAGS) $(LDFLAGS) -o $(SHLIB) $(OBJS) $(LIBS) $(PMUSRLIB) $(FFTW3LIB)
	@echo "done"

# clean up: remove all object file (and core files)
# semicolon needed to tell make there is no source
# for this target!
#
clean:; 	@rm -f $(OBJS) $(EXTOBJS) $(SHLIB) *Dict* core* *~
	@echo "---> removing $(OBJS) $(SHLIB)"


$(OBJS): %.o: %.cpp
	$(CXX) $(INCLUDES) $(CXXFLAGS) -c $<

# Generate the ROOT CINT dictionary

TVortexDict.cpp: ../include/TVortex.h ../include/TVortexLinkDef.h
	@echo "Generating dictionary $@..."
	rootcint -f $@ -c -p -I$(PMUSRPATH) $^

TLondon1DDict.cpp: ../include/TLondon1D.h ../include/TLondon1DLinkDef.h
	@echo "Generating dictionary $@..."
	rootcint -f $@ -c -p -I$(PMUSRPATH) $^

TSkewedGssDict.cpp: ../include/TSkewedGss.h ../include/TSkewedGssLinkDef.h
	@echo "Generating dictionary $@..."
	rootcint -f $@ -c -p -I$(PMUSRPATH) $^

TFitPofBStartupHandlerDict.cpp: ../include/TFitPofBStartupHandler.h ../include/TFitPofBStartupHandlerLinkDef.h
	@echo "Generating dictionary $@..."
	rootcint -f $@ -c -p $^

install: all
	@echo "Installing shared lib: $(SHLIB)"
ifeq ($(OS),LINUX)
	cp -pv $(SHLIB) $(ROOTSYS)/lib
	cp -pv $(INST_HEADER) $(ROOTSYS)/include
endif
ifeq ($(OS),WIN32GCC)
	cp -pv $(SHLIB) $(ROOTSYS)/bin
	ln -sf $(ROOTSYS)/bin/$(SHLIB) $(ROOTSYS)/lib/$(SHLIB)
	cp -pv $(INST_HEADER) $(ROOTSYS)/include
endif
ifeq ($(OS),DARWIN)
	cp -pv $(SHLIB) $(ROOTSYS)/lib
	cp -pv $(INST_HEADER) $(ROOTSYS)/include
endif

cleaninstall: clean install
